name: Release App

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./android
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ“± Prebuild
        working-directory: ./android
        run: npx expo prebuild --platform android --clean

      - name: ğŸ”§ Patch Kotlin Version
        working-directory: ./android
        run: |
          # Append local gradle.properties to generated android folder (DO NOT OVERWRITE)
          if [ -f "gradle.properties" ]; then
            cat gradle.properties >> android/gradle.properties
          fi
          
          # Append Kotlin version to existing gradle.properties if it exists
          echo "" >> android/gradle.properties
          echo "# Force Kotlin 1.9.25 for Compose compatibility" >> android/gradle.properties
          echo "kotlinVersion=1.9.25" >> android/gradle.properties
          
          # Patch all build.gradle files in android folder
          find android -name "build.gradle" -exec sed -i 's/1\.9\.24/1.9.25/g' {} \; 2>/dev/null || true
          find android -name "build.gradle.kts" -exec sed -i 's/1\.9\.24/1.9.25/g' {} \; 2>/dev/null || true
          
          # Patch node_modules expo-modules-core
          find node_modules -path "*/expo-modules-core/*" -name "build.gradle" -exec sed -i 's/1\.9\.24/1.9.25/g' {} \; 2>/dev/null || true
          find node_modules -path "*/expo-modules-core/*" -name "*.gradle" -exec sed -i 's/1\.9\.24/1.9.25/g' {} \; 2>/dev/null || true
          
          echo "Kotlin version patched to 1.9.25 everywhere"
          
          # Debug: show what version is in build.gradle
          grep -r "kotlinVersion" android/build.gradle || echo "kotlinVersion not found in main build.gradle"

      - name: ğŸ”¨ Build APK
        working-directory: ./android/android
        env:
          NODE_ENV: production
        run: ./gradlew assembleRelease --no-daemon

      - name: ğŸ” Debug APK Location
        working-directory: ./android
        run: find . -name "*.apk"

      - name: ğŸ“¦ Prepare APK
        id: prepare_apk
        working-directory: ./android
        run: |
          APK_PATH="$(find . -type f -name '*release*.apk' -o -name '*app-release*.apk' | head -n 1)"
          if [ -z "$APK_PATH" ]; then
            echo "::error::No APK found! checking debug..."
            APK_PATH="$(find . -type f -name '*.apk' | head -n 1)"
          fi
          
          if [ -z "$APK_PATH" ]; then
             echo "::error::Still no APK found."
             exit 1
          fi

          echo "Found APK at: $APK_PATH"
          
          # Rename for upload
          mv "$APK_PATH" ./RichieDrop-Android.apk
          echo "apk_path=RichieDrop-Android.apk" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Android Assets
        uses: softprops/action-gh-release@v2
        if: steps.prepare_apk.outputs.apk_path != ''
        with:
          files: android/${{ steps.prepare_apk.outputs.apk_path }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false

  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ”¨ Build Desktop App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'RichieDrop ${{ github.ref_name }}'
          args: ${{ matrix.args }}
